<html>
  <meta charset="utf-8">
    <style>
     td {
        padding: 5px;
     }
     .button {
       background-color: white;
       border: 2px solid black;
       color: black;
       padding: 5px;
       text-align: center;
       text-decoration: none;
       display: inline-block;
       font-size: 16px;
       -webkit-transition-duration: 0.4s; /* Safari */
       transition-duration: 0.4s;
     }
     .button:hover{
       background-color: black;
       color: white;
       cursor: pointer;
     }
     button[disabled] {
       opacity: .65;
     }
     button[disabled]:hover {
       color: black;
       background: white;
     }
   </style>
    <!-- Promise polyfill for IE11 -->
    <script src="vendor/promise.js"></script>

    <!-- ES2015/ES6 modules polyfill -->
    <script nomodule src="vendor/browser-es-module-loader/dist/browser-es-module-loader.js"></script>

    <!-- Auth0 library -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>

    <script type="module" crossorigin="anonymous">
      import * as WebUtil from "./app/webutil.js";
      const apiPrefix = 'https://api.hsrn.nyu.edu/apis';
      const oidcDomain = 'dev-corelink.us.auth0.com';
      const oidcClientId = '4I8K54Hz4bKU3ei0issNzZU4OeQkRP7b';
      let auth0Client = null;

      document.getElementById('btn-login').innerText = 'Loading...';

      async function login() {
        await auth0Client.loginWithRedirect({
          authorizationParams: {
            redirect_uri: 'http://localhost:8000/',
          },
        });

        loadVMI();
      }

      async function configureClient() {
        // Create client
        auth0Client = await auth0.createAuth0Client({
          domain: oidcDomain,
          clientId: oidcClientId,
        });

        // If authenticated, proceed, else enable button
        const isAuthenticated = await auth0Client.isAuthenticated();
        if(isAuthenticated) {
          loadVMI();
          return;
        }

        // Handle authentication callback
        const query = window.location.search;
        if(query.includes('code=') && query.includes('state=')) {
          await auth0Client.handleRedirectCallback();

          // Remove the query parameters
          window.history.replaceState({}, document.title, '/');

          loadVMI();
          return;
        }

        // Not logged in, show the button
        document.getElementById('btn-login').innerText = 'Log in';
        document.getElementById('btn-login').disabled = false;
        document.getElementById('btn-login').addEventListener('click', login);
      }
      window.addEventListener('load', configureClient);

      function loadVMI() {
        document.getElementById('btn-login').style.display = 'none';
        WebUtil.fetchJSON('/' + apiPrefix + '/kubevirt.io/v1alpha3/virtualmachineinstances/')
          .then((resp) => {
            document.getElementById("vmis").style.display = '';
            resp.items.forEach(i => {
              let tr = document.createElement('tr');
              tr.innerHTML="<td>" + i.metadata.namespace + "</td><td>" + i.metadata.name + "</td><td>" + String(i.status.phase) + "</td><td>" + String(i.status.interfaces !== undefined ? i.status.interfaces[0].ipAddress : '')  + "</td><td>" + String(i.status.nodeName !== undefined ? i.status.nodeName : '') + "</td><td><button class='button' " + String(i.status.phase =="Running" ? "" : "disabled")  + " onclick=\"window.open('vnc_lite.html?path=" + apiPrefix + "/subresources.kubevirt.io/v1alpha3/namespaces/" + namespace + "/virtualmachineinstances/" + i.metadata.name + "/vnc', 'novnc_window', 'resizable=yes,toolbar=no,location=no,status=no,scrollbars=no,menubar=no,width=1030,height=800')\">VNC</button></td>";
              document.getElementById("vmis").appendChild(tr);
            });
            if (resp.items.length === 0) {
              document.body.append("No virtual machines in the namespace.");
            }
          })
          .catch(err => console.log("Failed to get vmis: " + err));
       }
    </script>
  </meta>

  <body>
    <button id="btn-login" disable="true" disabled>Log in (requires JavaScript)</button>

    <table style="display: none;"><tbody id="vmis">
    </tbody></table>
  </body>
</html>
